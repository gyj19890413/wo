<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
	    <meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="format-detection" content="telephone=no" />
		<title>
			用户登录
		</title>
		<script>
			window.onresize = function(){
				getscreen();
			}
			
			function getscreen(){
				var screenWidth = document.documentElement.clientWidth;
				if(screenWidth>750){
					screenWidth=750
				}
				document.documentElement.style.fontSize = (100/750) * screenWidth + 'px';
			}
			getscreen();
		</script>
		<link rel="stylesheet" href="/public/static/index/css/style.css?t=201766" />
		<link rel="stylesheet" href="/public/static/index/css/register.css?t=201766" />

		<script type="text/javascript" src="/public/static/index/js/jquery-2.1.0.js" ></script>
	</head>
	<body>
		<div class="login_box">						
			<label class="user">
				<input type="text" name="user" placeholder="请输入用户名" maxlength="11" value="17602150413"/>
				<i></i>
			</label>
			<div class="pass">
				<input type="tel" name="pass" maxlength="6" placeholder="请输入验证码" />
				<label class="code_click" for="code">
					获取验证码
				</label>
				<i></i>
			</div>
			<p class="errortips">
				<span></span>
			</p>
			<div class="login_btn">
				登录
			</div>
			<div class="code_box">
				<div class="cover"></div>
				<div class="code_box_content">
					<div class="codeimg"><img src="{:captcha_src()}"/></div>
					<input type="tel" id="code" maxlength="4"/>
					<div class="code_btn">
						确定
					</div>
				</div>
				
			</div>
		</div>
		<script type="text/javascript">
			var imgURL ='{:url("/index/login/login")}';
			var URL ='{:url("/index/login/login")}';
		</script>
		<!--<script type="text/javascript" src="/public/static/index/js/register.js" ></script>-->
	</body>
	<script type="text/javascript">
		(function(){
			var Itimer='';
			
			$('.code_click').click(function(){
				if($(this).hasClass('focus')){
					tips('请不要频繁点击');
					return false;
				};
				var phone = $('input[name=user]').val();
				if(!/^13[\d]{9}$|^14[0-9]{1}\d{8}$|^15[^4]{1}\d{8}$|^17[0-9]{1}\d{8}$|^18[\d]{9}$/.test(phone)){
					$('.user').addClass('focus');
					tips('输入手机号不符合规则');
					return false;
				};
				imgChange();
				$('.code_box').show();
				
			});
			$('.cover').click(function(){
				$('.code_box').hide();
				return false;
			});
			
			$('.code_btn').click(function(){
				$('.code_box').hide();
				var code= $('#code').val();
				if(code.length!=4){
					tips('图片验证码错误');
					return false;
				};				
				
				sendSms({'phone':$('input[name=user]').val(),'code':code});
				
			});
			
			function countdown(){										
				clearInterval(Itimer);
				var countnum = 60;
				$('.code_click').html(countnum);
				Itimer= setInterval(function(){
					countnum--;
					if(countnum==-1){
						clearInterval(Itimer);
						countnum='获取验证码';
						$('.code_click').removeClass('focus');
					};					
					$('.code_click').html(countnum);					
				},1000);
			};
			$('.codeimg img').click(function(){
				imgChange();
			});
			function imgChange(){
				var src = $('.codeimg img').attr('src');
				$('.codeimg img').attr('src',src);
			};
			function sendSms (param){
				$('.code_click').addClass('focus');
				$.ajax({
					type:"post",
					url:imgURL,
					async:true,
					dataType:'json',
					data:param,
					success:function(resp){
						if(resp.code==200){
							countdown();
						}else{
							$('.code_click').removeClass('focus');
							tips(resp.msg);	
						}
					}
				})
			}
			
			
			$('.login_btn').on('click',function(){
				var username =$('input[name=user]').val();
				username =$.trim(username);
				if(!/^13[\d]{9}$|^14[0-9]{1}\d{8}$|^15[^4]{1}\d{8}$|^17[0-9]{1}\d{8}$|^18[\d]{9}$/.test(username)){
				
					tips('输入手机号不符合规则');
					return false;
				};
				var pass =$('input[name=pass]').val();
				pass =$.trim(pass);
				if(pass.length!=6){
				
					tips('验证码错误');
					return false;
				};
				
					sub_user({username:username,pass:pass});
			});
			
			
			function sub_user(param){
				$.ajax({
					type:"post",
					url:URL,
					async:true,
					dataType:'json',
					data:param,
					success:function(resp){
						console.log(resp);
						if(resp.code==200){
							if(resp.url){
								window.location.href=resp.url;
							}else{
								window.history.go(-1);
							}
						}else if(resp.code==201){
							tips(resp.msg);
						}
						
					}
				});
			}
			var timer;
			function tips(str){
				clearTimeout(timer);
				$('.errortips span').html(str);
				timer=setTimeout(function(){
					$('.errortips span').html('');
					
				},3000);
			}
		})();


	</script>
</html>
